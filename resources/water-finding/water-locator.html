<!DOCTYPE html>
<html dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù…Ø§Ø¡ - ØºØ²Ø©</title>
    <style>
        body { 
            font-family: Arial; 
            margin: 0; 
            padding: 10px;
            background: #f0f0f0;
        }
        .container { 
            max-width: 400px; 
            margin: auto;
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 20px;
        }
        button { 
            width: 100%; 
            padding: 15px; 
            margin: 10px 0;
            font-size: 18px;
            border: none;
            border-radius: 5px;
            background: #4CAF50;
            color: white;
            cursor: pointer;
            transition: background 0.3s;
        }
        button:hover { background: #45a049; }
        button:active { background: #3d8b40; }
        .danger { background: #f44336; }
        .danger:hover { background: #da190b; }
        .warning { background: #ff9800; }
        .warning:hover { background: #e68900; }
        #status { 
            padding: 10px; 
            background: #e7f3ff;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
        }
        .water-point {
            background: #f9f9f9;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border-right: 5px solid #2196F3;
            position: relative;
        }
        .water-point.clean { border-color: #4CAF50; }
        .water-point.warning { border-color: #ff9800; }
        .water-point.empty { border-color: #f44336; }
        select, input {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            box-sizing: border-box;
        }
        .delete-btn {
            position: absolute;
            top: 10px;
            left: 10px;
            background: #f44336;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        .coords {
            font-family: monospace;
            font-size: 12px;
            color: #666;
        }
        .time {
            font-size: 11px;
            color: #999;
        }
        a {
            color: #2196F3;
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
        }
        .info-box {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            font-size: 14px;
        }
        .stats {
            background: #e8f5e9;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
        }
        .distance {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” Ù…Ø­Ø¯Ø¯ Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ù…Ø§Ø¡ - ØºØ²Ø©</h1>
        
        <div class="info-box">
            ğŸ’¡ Ù‡Ø°Ø§ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙŠØ¹Ù…Ù„ Ø¨Ø¯ÙˆÙ† Ø¥Ù†ØªØ±Ù†Øª. Ø´Ø§Ø±Ùƒ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ù…Ø¹ Ø¬ÙŠØ±Ø§Ù†Ùƒ Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¬Ù…ÙŠØ¹.
        </div>
        
        <button onclick="getLocation()">ğŸ“ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ</button>
        <div id="status"></div>
        
        <h3>Ø¥Ø¶Ø§ÙØ© Ù†Ù‚Ø·Ø© Ù…Ø§Ø¡ Ø¬Ø¯ÙŠØ¯Ø©:</h3>
        <select id="waterStatus">
            <option value="clean">âœ… Ù…Ø§Ø¡ Ù†Ø¸ÙŠÙ ØµØ§Ù„Ø­ Ù„Ù„Ø´Ø±Ø¨</option>
            <option value="warning">âš ï¸ Ù…Ø§Ø¡ Ù…ØªÙˆÙØ± Ù„ÙƒÙ† ÙŠØ­ØªØ§Ø¬ ØªÙ†Ù‚ÙŠØ©/ØºÙ„ÙŠ</option>
            <option value="empty">âŒ Ù†ÙØ° Ø§Ù„Ù…Ø§Ø¡ / Ù…ØºÙ„Ù‚</option>
        </select>
        
        <input type="text" id="locationName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙƒØ§Ù† (Ù…Ø«Ù„: Ù…Ø³Ø¬Ø¯ Ø§Ù„Ù†ÙˆØ±)">
        <input type="text" id="notes" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ù…Ø«Ù„: Ù…ØªÙˆÙØ± ØµØ¨Ø§Ø­Ø§Ù‹ ÙÙ‚Ø·)">
        <button onclick="saveLocation()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…ÙˆÙ‚Ø¹</button>
        
        <div class="stats" id="stats"></div>
        
        <h3>Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©:</h3>
        <button onclick="sortByDistance()" style="background: #2196F3">ğŸ“ ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ©</button>
        <div id="savedLocations"></div>
        
        <button onclick="shareData()" class="warning">ğŸ“¤ Ù…Ø´Ø§Ø±ÙƒØ© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
        <button onclick="exportHTML()" style="background: #9C27B0">ğŸ’¾ ØªØµØ¯ÙŠØ± ÙƒØµÙØ­Ø© HTML</button>
        <button onclick="importData()" style="background: #607D8B">ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</button>
        <button onclick="clearAll()" class="danger">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
    </div>

    <script>
        let currentLat = 0;
        let currentLon = 0;

        function getLocation() {
            const status = document.getElementById('status');
            
            if (!navigator.geolocation) {
                status.innerHTML = 'âŒ GPS ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø²';
                return;
            }

            status.innerHTML = 'â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹...';
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    currentLat = position.coords.latitude;
                    currentLon = position.coords.longitude;
                    const accuracy = position.coords.accuracy;
                    status.innerHTML = `âœ… ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ø¯Ù‚Ø© ${accuracy.toFixed(0)} Ù…ØªØ±<br>
                        <span class="coords">Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª: ${currentLat.toFixed(6)}, ${currentLon.toFixed(6)}</span>`;
                    updateDistances();
                },
                (error) => {
                    status.innerHTML = 'âŒ ÙØ´Ù„ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹. ØªØ£ÙƒØ¯ Ù…Ù† ØªÙØ¹ÙŠÙ„ GPS ÙˆØ§Ù„Ø³Ù…Ø§Ø­ Ù„Ù„Ù…ØªØµÙØ­';
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000; // Earth radius in meters
            const Ï†1 = lat1 * Math.PI/180;
            const Ï†2 = lat2 * Math.PI/180;
            const Î”Ï† = (lat2-lat1) * Math.PI/180;
            const Î”Î» = (lon2-lon1) * Math.PI/180;

            const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) +
                    Math.cos(Ï†1) * Math.cos(Ï†2) *
                    Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c;
        }

        function formatDistance(meters) {
            if (meters < 1000) {
                return `${meters.toFixed(0)} Ù…ØªØ±`;
            } else {
                return `${(meters/1000).toFixed(1)} ÙƒÙ…`;
            }
        }

        function saveLocation() {
            if (currentLat === 0) {
                alert('ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø£ÙˆÙ„Ø§Ù‹ Ø¨Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± "ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ÙŠ"');
                return;
            }

            const waterStatus = document.getElementById('waterStatus').value;
            const locationName = document.getElementById('locationName').value;
            const notes = document.getElementById('notes').value;
            const timestamp = new Date().toLocaleString('ar-EG');
            
            if (!locationName) {
                alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…ÙƒØ§Ù†');
                return;
            }

            const location = {
                id: Date.now(),
                lat: currentLat,
                lon: currentLon,
                status: waterStatus,
                name: locationName,
                notes: notes,
                time: timestamp
            };

            let saved = JSON.parse(localStorage.getItem('waterLocations') || '[]');
            saved.push(location);
            localStorage.setItem('waterLocations', JSON.stringify(saved));
            
            document.getElementById('locationName').value = '';
            document.getElementById('notes').value = '';
            alert('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ù†Ø¬Ø§Ø­');
            displayLocations();
            updateStats();
        }

        function deleteLocation(id) {
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆÙ‚Ø¹ØŸ')) {
                let saved = JSON.parse(localStorage.getItem('waterLocations') || '[]');
                saved = saved.filter(loc => loc.id !== id);
                localStorage.setItem('waterLocations', JSON.stringify(saved));
                displayLocations();
                updateStats();
            }
        }

        function updateDistances() {
            if (currentLat === 0) return;
            
            let saved = JSON.parse(localStorage.getItem('waterLocations') || '[]');
            saved.forEach(loc => {
                loc.distance = calculateDistance(currentLat, currentLon, loc.lat, loc.lon);
            });
            localStorage.setItem('waterLocations', JSON.stringify(saved));
            displayLocations();
        }

        function sortByDistance() {
            if (currentLat === 0) {
                alert('ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ Ø£ÙˆÙ„Ø§Ù‹');
                getLocation();
                return;
            }
            
            let saved = JSON.parse(localStorage.getItem('waterLocations') || '[]');
            saved.sort((a, b) => (a.distance || Infinity) - (b.distance || Infinity));
            localStorage.setItem('waterLocations', JSON.stringify(saved));
            displayLocations();
        }

        function displayLocations() {
            const saved = JSON.parse(localStorage.getItem('waterLocations') || '[]');
            const container = document.getElementById('savedLocations');
            
            if (saved.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ù‚Ø¹ Ù…Ø­ÙÙˆØ¸Ø©</p>';
                return;
            }

            container.innerHTML = saved.map((loc) => {
                const statusEmoji = {
                    'clean': 'âœ…',
                    'warning': 'âš ï¸',
                    'empty': 'âŒ'
                }[loc.status];
                
                const statusText = {
                    'clean': 'Ù…Ø§Ø¡ Ù†Ø¸ÙŠÙ',
                    'warning': 'ÙŠØ­ØªØ§Ø¬ ØªÙ†Ù‚ÙŠØ©',
                    'empty': 'Ù†ÙØ°/Ù…ØºÙ„Ù‚'
                }[loc.status];
                
                return `
                    <div class="water-point ${loc.status}">
                        <button class="delete-btn" onclick="deleteLocation(${loc.id})">Ø­Ø°Ù</button>
                        <strong>${statusEmoji} ${loc.name}</strong><br>
                        <span style="color: #666;">${statusText}</span><br>
                        ${loc.notes ? `ğŸ“ ${loc.notes}<br>` : ''}
                        ${loc.distance ? `<div class="distance">ğŸ“ Ø§Ù„Ù…Ø³Ø§ÙØ©: ${formatDistance(loc.distance)}</div>` : ''}
                        <span class="coords">ğŸ“ ${loc.lat.toFixed(6)}, ${loc.lon.toFixed(6)}</span><br>
                        <span class="time">ğŸ• ${loc.time}</span><br>
                        <a href="https://maps.google.com/?q=${loc.lat},${loc.lon}" target="_blank">
                            ğŸ—ºï¸ Ø¹Ø±Ø¶ Ø¹Ù„Ù‰ Ø®Ø±Ø§Ø¦Ø· Ø¬ÙˆØ¬Ù„
                        </a> | 
                        <a href="geo:${loc.lat},${loc.lon}" target="_blank">
                            ğŸ“± ÙØªØ­ ÙÙŠ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø®Ø±Ø§Ø¦Ø·
                        </a>
                    </div>
                `;
            }).join('');
        }

        function updateStats() {
            const saved = JSON.parse(localStorage.getItem('waterLocations') || '[]');
            const stats = document.getElementById('stats');
            
            const clean = saved.filter(l => l.status === 'clean').length;
            const warning = saved.filter(l => l.status === 'warning').length;
            const empty = saved.filter(l => l.status === 'empty').length;
            
            stats.innerHTML = `
                ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª: 
                âœ… ${clean} Ù†Ø¸ÙŠÙ | 
                âš ï¸ ${warning} ÙŠØ­ØªØ§Ø¬ ØªÙ†Ù‚ÙŠØ© | 
                âŒ ${empty} Ù†ÙØ° | 
                Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: ${saved.length}
            `;
        }

        function shareData() {
            const saved = JSON.parse(localStorage.getItem('waterLocations') || '[]');
            if (saved.length === 0) {
                alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ©');
                return;
            }

            let text = 'ğŸ“ Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ù…Ø§Ø¡ ÙÙŠ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©:\n';
            text += `Ø§Ù„ØªØ­Ø¯ÙŠØ«: ${new Date().toLocaleString('ar-EG')}\n\n`;
            
            saved.forEach((loc, index) => {
                const statusText = {
                    'clean': 'Ù…Ø§Ø¡ Ù†Ø¸ÙŠÙ âœ…',
                    'warning': 'ÙŠØ­ØªØ§Ø¬ ØªÙ†Ù‚ÙŠØ© âš ï¸',
                    'empty': 'Ù†ÙØ°/Ù…ØºÙ„Ù‚ âŒ'
                }[loc.status];
                
                text += `${index + 1}. ${loc.name} - ${statusText}\n`;
                if (loc.notes) text += `   Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ${loc.notes}\n`;
                text += `   ğŸ“ ${loc.lat.toFixed(6)}, ${loc.lon.toFixed(6)}\n`;
                text += `   ğŸ—ºï¸ https://maps.google.com/?q=${loc.lat},${loc.lon}\n\n`;
            });

            if (navigator.share) {
                navigator.share({
                    title: 'Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ù…Ø§Ø¡ ÙÙŠ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©',
                    text: text
                }).catch(err => {
                    copyToClipboard(text);
                });
            } else {
                copyToClipboard(text);
            }
        }

        function copyToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            alert('âœ… ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª - ÙŠÙ…ÙƒÙ†Ùƒ Ù„ØµÙ‚Ù‡Ø§ ÙÙŠ Ø£ÙŠ ØªØ·Ø¨ÙŠÙ‚');
        }

        function exportHTML() {
            const saved = JSON.parse(localStorage.getItem('waterLocations') || '[]');
            const dataStr = JSON.stringify(saved);
            const htmlContent = `
<!DOCTYPE html>
<html dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ù…Ø§Ø¡ - ${new Date().toLocaleDateString('ar-EG')}</title>
    <style>
        body { font-family: Arial; padding: 20px; background: #f0f0f0; }
        .container { max-width: 600px; margin: auto; background: white; padding: 20px; border-radius: 10px; }
        .water-point { background: #f9f9f9; padding: 15px; margin: 10px 0; border-radius: 5px; border-right: 5px solid #2196F3; }
        .clean { border-color: #4CAF50; }
        .warning { border-color: #ff9800; }
        .empty { border-color: #f44336; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ù…Ø§Ø¡ - ${new Date().toLocaleString('ar-EG')}</h1>
        <div id="locations"></div>
    </div>
    <script>
        const data = ${dataStr};
        const container = document.getElementById('locations');
        container.innerHTML = data.map(loc => {
            const statusEmoji = {'clean': 'âœ…', 'warning': 'âš ï¸', 'empty': 'âŒ'}[loc.status];
            const statusText = {'clean': 'Ù…Ø§Ø¡ Ù†Ø¸ÙŠÙ', 'warning': 'ÙŠØ­ØªØ§Ø¬ ØªÙ†Ù‚ÙŠØ©', 'empty': 'Ù†ÙØ°/Ù…ØºÙ„Ù‚'}[loc.status];
            return \`
                <div class="water-point \${loc.status}">
                    <strong>\${statusEmoji} \${loc.name}</strong><br>
                    \${statusText}<br>
                    \${loc.notes ? 'ğŸ“ ' + loc.notes + '<br>' : ''}
                    ğŸ“ \${loc.lat.toFixed(6)}, \${loc.lon.toFixed(6)}<br>
                    <a href="https://maps.google.com/?q=\${loc.lat},\${loc.lon}" target="_blank">ğŸ—ºï¸ Ø¹Ø±Ø¶ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</a>
                </div>
            \`;
        }).join('');
    </script>
</body>
</html>`;
            
            const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `water-locations-${new Date().toISOString().split('T')[0]}.html`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importData() {
            const input = prompt('Ø§Ù„ØµÙ‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØµØ¯Ø±Ø© Ù‡Ù†Ø§ (JSON format):');
            if (!input) return;
            
            try {
                const imported = JSON.parse(input);
                if (!Array.isArray(imported)) {
                    throw new Error('Invalid format');
                }
                
                const saved = JSON.parse(localStorage.getItem('waterLocations') || '[]');
                const merged = [...saved, ...imported];
                
                // Remove duplicates based on coordinates
                const unique = merged.filter((loc, index, self) =>
                    index === self.findIndex((l) => l.lat === loc.lat && l.lon === loc.lon)
                );
                
                localStorage.setItem('waterLocations', JSON.stringify(unique));
                displayLocations();
                updateStats();
                alert(`âœ… ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${imported.length} Ù…ÙˆÙ‚Ø¹`);
            } catch (e) {
                alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯Ø©');
            }
        }

        function clearAll() {
            if (confirm('âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡!')) {
                localStorage.removeItem('waterLocations');
                displayLocations();
                updateStats();
            }
        }

        // Initialize on load
        displayLocations();
        updateStats();
        
        // Auto-get location on load
        setTimeout(() => {
            getLocation();
        }, 1000);
    </script>
</body>
</html>